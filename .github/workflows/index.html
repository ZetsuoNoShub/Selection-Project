<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Space Shooter Game</title>
  <style>
    body {
      margin: 0;
      background: #000;
      color: white;
      font-family: Arial, sans-serif;
      text-align: center;
    }
    canvas {
      display: block;
      margin: 20px auto;
      border: 2px solid #fff;
    }
    #startScreen, #gameOverScreen, #winScreen {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.8);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    button {
      padding: 10px 20px;
      font-size: 18px;
      margin-top: 20px;
      cursor: pointer;
      background-color: #0f0;
      border: none;
      color: black;
      font-weight: bold;
    }
    #gameOverScreen, #winScreen { display: none; }
    #bossHpBarContainer {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        width: 300px;
        height: 15px;
        background-color: #333;
        border: 2px solid #fff;
        display: none;
        z-index: 10;
    }
    #bossHpBar {
        height: 100%;
        width: 100%;
        background-color: #f00;
        transition: width 0.1s;
    }
    #bossHpText {
        position: absolute;
        width: 100%;
        text-align: center;
        line-height: 15px;
        font-size: 12px;
        font-weight: bold;
        color: white;
        text-shadow: 1px 1px 2px black;
    }
    #loadingScreen {
        position: absolute;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,1);
        display: flex;
        justify-content: center;
        align-items: center;
        color: white;
        font-size: 24px;
        z-index: 100;
    }
    #powerupIndicator {
        position: absolute;
        top: 10px;
        right: 10px;
        padding: 5px 10px;
        background: rgba(0,0,0,0.7);
        border: 1px solid #0f0;
        display: none;
    }
  </style>
</head>
<body>
  <div id="loadingScreen">Loading Assets...</div>
  <div id="startScreen" style="display: none;">
    <h1>Space Shooter</h1>
    <p>Use <strong>Arrow Keys</strong> to move and <strong>Spacebar</strong> to shoot!</p>
    <p>Collect power-ups for special weapons!</p>
    <button id="startButton">Start Game</button>
  </div>
  <div id="gameOverScreen">
    <h1>Game Over</h1>
    <p>Your Score: <span id="finalScore">0</span></p>
    <button id="restartButton">Restart</button>
  </div>
  <div id="winScreen">
    <h1>You Won!</h1>
    <p>Your Score: <span id="winScore">0</span></p>
    <button id="restartWinButton">Play Again</button>
  </div>
  <div id="bossHpBarContainer">
      <div id="bossHpText">BOSS HP</div>
      <div id="bossHpBar"></div>
  </div>
  <div id="powerupIndicator">Power-Up Active: <span id="powerupType">None</span> (<span id="powerupTimer">0</span>s)</div>
  <p>Score: <span id="score">0</span> | Lives: <span id="lives">3</span></p>
  <canvas id="gameCanvas" width="800" height="600"></canvas>

  <script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    let gameRunning = false;
    let score = 0;
    let lives = 3;
    let lastShootTime = 0;
    const shootInterval = 200;

    const BOSS_HP_MAX = 400;

    let assetsLoaded = 0;
    const assetsToLoad = 5;

    function assetLoaded() {
      assetsLoaded++;
      if (assetsLoaded === assetsToLoad) {
        document.getElementById('loadingScreen').style.display = 'none';
        document.getElementById('startScreen').style.display = 'flex';
        draw();
      }
    }

    function placeholder(color) {
      const c = document.createElement('canvas');
      c.width = 50; c.height = 50;
      const g = c.getContext('2d');
      g.fillStyle = color;
      g.fillRect(0,0,50,50);
      return c;
    }

    const backgroundImg = new Image();
    backgroundImg.onload = assetLoaded;
    backgroundImg.onerror = () => { backgroundImg.src = placeholder("#000").toDataURL(); assetLoaded(); };
    backgroundImg.src = "pics/background.png";

    const playerImg = new Image();
    playerImg.onload = assetLoaded;
    playerImg.onerror = () => { playerImg.src = placeholder("#0f0").toDataURL(); assetLoaded(); };
    playerImg.src = "pics/player_ship.png";

    const bossImg = new Image();
    bossImg.onload = assetLoaded;
    bossImg.onerror = () => { bossImg.src = placeholder("#f00").toDataURL(); assetLoaded(); };
    bossImg.src = "pics/boss1png.webp";

    const enemyImgs = [new Image(), new Image()];
    enemyImgs[0].onload = assetLoaded;
    enemyImgs[1].onload = assetLoaded;
    enemyImgs[0].src = "pics/enemy_1png.webp";
    enemyImgs[1].src = "pics/enemy_2.png";

    const player = { x: 375, y: 520, width: 50, height: 50, speed: 5 };
    let bullets = [];
    let asteroids = [];
    let enemyBullets = [];
    let boss = null;
    let bossBullets = [];
    let explosions = [];
    let enemySpawnTimer = 0;
    let bgY = 0;
    let lastBossShot = 0;
    let powerups = [];
    let powerupActive = null;
    let powerupTimer = 0;
    let bossMoveDirection = 1; // 1 for right, -1 for left
    let bossMoveTimer = 0;
    let bossPhase = 1; // 1 for normal, 2 for aggressive

    const keys = {};
    window.addEventListener("keydown", e => { keys[e.code] = true; });
    window.addEventListener("keyup", e => { keys[e.code] = false; });

    document.getElementById("startButton").onclick = startGame;
    document.getElementById("restartButton").onclick = startGame;
    document.getElementById("restartWinButton").onclick = startGame;

    function startGame() {
      gameRunning = true;
      score = 0;
      lives = 3;
      bullets = [];
      asteroids = [];
      enemyBullets = [];
      bossBullets = [];
      boss = null;
      explosions = [];
      powerups = [];
      powerupActive = null;
      powerupTimer = 0;
      enemySpawnTimer = 0;
      bgY = 0;
      lastBossShot = 0;
      bossMoveDirection = 1;
      bossMoveTimer = 0;
      bossPhase = 1;
      document.getElementById("startScreen").style.display = "none";
      document.getElementById("gameOverScreen").style.display = "none";
      document.getElementById("winScreen").style.display = "none";
      document.getElementById("bossHpBarContainer").style.display = "none";
      document.getElementById("powerupIndicator").style.display = "none";
      updateScore();
      requestAnimationFrame(gameLoop);
    }

    function gameOver() {
      gameRunning = false;
      document.getElementById("finalScore").textContent = score;
      document.getElementById("gameOverScreen").style.display = "flex";
    }

    function gameWin() {
      gameRunning = false;
      document.getElementById("winScore").textContent = score;
      document.getElementById("winScreen").style.display = "flex";
    }

    function updateScore() {
      document.getElementById("score").textContent = score;
      document.getElementById("lives").textContent = lives;
    }

    function shoot() {
      if (powerupActive === "triple") {
        // Triple shot
        bullets.push({ 
          x: player.x + player.width/2 - 5, 
          y: player.y, 
          width: 10, height: 20, 
          speed: 8 
        });
        bullets.push({ 
          x: player.x + player.width/4 - 5, 
          y: player.y, 
          width: 10, height: 20, 
          speed: 8 
        });
        bullets.push({ 
          x: player.x + 3*player.width/4 - 5, 
          y: player.y, 
          width: 10, height: 20, 
          speed: 8 
        });
      } else if (powerupActive === "rapid") {
        // Rapid fire
        bullets.push({ 
          x: player.x + player.width/2 - 5, 
          y: player.y, 
          width: 10, height: 20, 
          speed: 8 
        });
      } else {
        // Normal shot
        bullets.push({ 
          x: player.x + player.width/2 - 5, 
          y: player.y, 
          width: 10, height: 20, 
          speed: 8 
        });
      }
    }

    function createAsteroid() {
      const size = 40;
      asteroids.push({
        x: Math.random() * (canvas.width - size),
        y: -size,
        width: size,
        height: size,
        speed: Math.random() * 2 + 1,
        image: enemyImgs[Math.floor(Math.random()*2)]
      });
    }

    function createBoss() {
      boss = {
        x: canvas.width/2 - 100,
        y: 40,
        width: 160,
        height: 80,
        hp: BOSS_HP_MAX,
        moveSpeed: 2
      };
      document.getElementById("bossHpBarContainer").style.display = "block";
    }

    function spawnPowerup(x, y) {
      if (Math.random() < 0.3) { // 30% chance to spawn powerup
        const types = ["triple", "rapid"];
        powerups.push({
          x: x,
          y: y,
          width: 30,
          height: 30,
          type: types[Math.floor(Math.random() * types.length)],
          speed: 2
        });
      }
    }

    function activatePowerup(type) {
      powerupActive = type;
      powerupTimer = 10 * 1000; // 10 seconds
      document.getElementById("powerupIndicator").style.display = "block";
      document.getElementById("powerupType").textContent = type;
      document.getElementById("powerupTimer").textContent = "10";
    }

    function updatePowerupTimer() {
      if (powerupActive) {
        powerupTimer -= 16; // Assuming 60fps
        if (powerupTimer <= 0) {
          powerupActive = null;
          document.getElementById("powerupIndicator").style.display = "none";
        } else {
          document.getElementById("powerupTimer").textContent = Math.ceil(powerupTimer / 1000);
        }
      }
    }

    function isColliding(a,b) {
      return a.x < b.x+b.width && a.x+a.width > b.x && a.y < b.y+b.height && a.y+a.height > b.y;
    }

    function update() {
      if (!gameRunning) return;
      const now = Date.now();

      if (keys["ArrowLeft"] && player.x > 0) player.x -= player.speed;
      if (keys["ArrowRight"] && player.x < canvas.width-player.width) player.x += player.speed;
      if (keys["ArrowUp"] && player.y > 0) player.y -= player.speed;
      if (keys["ArrowDown"] && player.y < canvas.height-player.height) player.y += player.speed;
      
      // Shooting with different intervals based on powerup
      let currentShootInterval = shootInterval;
      if (powerupActive === "rapid") currentShootInterval = shootInterval / 2;
      
      if (keys["Space"] && now-lastShootTime > currentShootInterval) { 
        shoot(); 
        lastShootTime=now; 
      }

      bullets.forEach((b,i)=>{ b.y -= b.speed; if (b.y<-20) bullets.splice(i,1); });

      enemySpawnTimer++;
      if (enemySpawnTimer > 90) {
        createAsteroid();
        enemySpawnTimer = 0;
      }

      // enemy movement + chance to shoot
      asteroids.forEach((a,i)=>{ 
        a.y += a.speed; 
        if (a.y>canvas.height) asteroids.splice(i,1); 
        if (isColliding(player,a)) { 
          explosions.push({x:a.x,y:a.y,life:20}); 
          asteroids.splice(i,1); 
          lives--; 
          updateScore(); 
          if(lives<=0) gameOver(); 
        }
        if (Math.random() < 0.003) {
          enemyBullets.push({x:a.x+a.width/2-3,y:a.y+a.height,width:6,height:12,speed:4});
        }
      });

      bullets.forEach((b,bi)=>{
        asteroids.forEach((a,ai)=>{
          if(isColliding(b,a)){ 
            explosions.push({x:a.x,y:a.y,life:20}); 
            bullets.splice(bi,1); 
            asteroids.splice(ai,1); 
            score+=10; 
            updateScore(); 
            spawnPowerup(a.x, a.y);
          }
        });
      });

      // enemy bullets hit player
      enemyBullets.forEach((eb,ei)=>{
        eb.y += eb.speed;
        if (eb.y > canvas.height) enemyBullets.splice(ei,1);
        if (isColliding(player,eb)) { 
          enemyBullets.splice(ei,1); 
          lives--; 
          updateScore(); 
          if(lives<=0) gameOver(); 
        }
      });

      // spawn boss
      if(score>=100 && !boss) createBoss();

      // boss movement
      if (boss) {
        bossMoveTimer++;
        
        // Change direction every 2 seconds or when hitting the edge
        if (bossMoveTimer > 120 || (boss.x <= 0 && bossMoveDirection === -1) || (boss.x + boss.width >= canvas.width && bossMoveDirection === 1)) {
          bossMoveDirection *= -1;
          bossMoveTimer = 0;
        }
        
        boss.x += boss.moveSpeed * bossMoveDirection;
        
        // Boss phase change at 50% HP
        if (boss.hp <= BOSS_HP_MAX / 2 && bossPhase === 1) {
          bossPhase = 2;
          boss.moveSpeed = 3; // Faster movement
        }
      }

      // boss shooting
      if (boss) {
        let bossShootInterval = 1200;
        if (bossPhase === 2) bossShootInterval = 800; // Faster shooting in phase 2
        
        if (now - lastBossShot > bossShootInterval) {
          // Different shooting patterns based on phase
          if (bossPhase === 1) {
            // Single shot in phase 1
            bossBullets.push({
              x: boss.x + boss.width/2 - 8,
              y: boss.y + boss.height,
              width: 16, height: 24,
              speed: 5
            });
          } else {
            // Triple shot in phase 2
            bossBullets.push({
              x: boss.x + boss.width/2 - 8,
              y: boss.y + boss.height,
              width: 16, height: 24,
              speed: 5
            });
            bossBullets.push({
              x: boss.x + boss.width/4 - 8,
              y: boss.y + boss.height,
              width: 16, height: 24,
              speed: 5,
              angle: -0.2 // Slight angle
            });
            bossBullets.push({
              x: boss.x + 3*boss.width/4 - 8,
              y: boss.y + boss.height,
              width: 16, height: 24,
              speed: 5,
              angle: 0.2 // Slight angle
            });
          }
          lastBossShot = now;
        }
      }

      // boss bullets
      bossBullets.forEach((bb,bi)=>{
        // Handle angled bullets
        if (bb.angle) {
          bb.x += Math.sin(bb.angle) * 3;
          bb.y += bb.speed;
        } else {
          bb.y += bb.speed;
        }
        
        if (bb.y > canvas.height) bossBullets.splice(bi,1);
        if (isColliding(player,bb)) { 
          bossBullets.splice(bi,1); 
          lives--; 
          updateScore(); 
          if(lives<=0) gameOver(); 
        }
      });

      // player hits boss
      if (boss) {
        bullets.forEach((b,bi)=>{
          if(isColliding(b,boss)){ 
            bullets.splice(bi,1); 
            boss.hp -= 10; 
            document.getElementById("bossHpBar").style.width = (boss.hp/BOSS_HP_MAX*100)+"%";
            if(boss.hp<=0){ 
              explosions.push({x:boss.x,y:boss.y,life:40}); 
              score+=200; 
              updateScore(); 
              gameWin(); 
            }
          }
        });
      }

      // powerups
      powerups.forEach((p,i)=>{
        p.y += p.speed;
        if (p.y > canvas.height) powerups.splice(i,1);
        if (isColliding(player,p)) { 
          powerups.splice(i,1); 
          activatePowerup(p.type);
        }
      });

      updatePowerupTimer();

      bgY += 2;
      if (bgY >= canvas.height) bgY = 0;
    }

    function draw() {
      ctx.drawImage(backgroundImg,0,bgY,canvas.width,canvas.height);
      ctx.drawImage(backgroundImg,0,bgY-canvas.height,canvas.width,canvas.height);

      ctx.drawImage(playerImg,player.x,player.y,player.width,player.height);

      bullets.forEach(b=>{
        ctx.fillStyle="orange";
        ctx.fillRect(b.x,b.y,b.width,b.height);
      });

      asteroids.forEach(a=>{ ctx.drawImage(a.image,a.x,a.y,a.width,a.height); });

      enemyBullets.forEach(eb=>{
        ctx.fillStyle="yellow";
        ctx.fillRect(eb.x,eb.y,eb.width,eb.height);
      });

      if(boss) ctx.drawImage(bossImg,boss.x,boss.y,boss.width,boss.height);

      bossBullets.forEach(bb=>{
        ctx.fillStyle="red";
        ctx.fillRect(bb.x,bb.y,bb.width,bb.height);
      });

      // Draw powerups
      powerups.forEach(p=>{
        ctx.fillStyle = p.type === "triple" ? "cyan" : "magenta";
        ctx.beginPath();
        ctx.arc(p.x + p.width/2, p.y + p.height/2, p.width/2, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = "white";
        ctx.font = "12px Arial";
        ctx.textAlign = "center";
        ctx.fillText(p.type === "triple" ? "T" : "R", p.x + p.width/2, p.y + p.height/2 + 4);
      });

      explosions.forEach((e,i)=>{
        ctx.fillStyle="red";
        ctx.beginPath();
        ctx.arc(e.x+20,e.y+20,20,0,Math.PI*2);
        ctx.fill();
        e.life--; if(e.life<=0) explosions.splice(i,1);
      });
    }

    function gameLoop(){
      if(!gameRunning) return;
      update();
      draw();
      requestAnimationFrame(gameLoop);
    }
  </script>
</body>
</html>
